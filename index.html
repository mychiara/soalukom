<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Soal Keperawatan</title>
    <link rel="stylesheet" href="style.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> -->
    <style>
        .developer-credit {
            margin-top: 20px;
            text-align: center;
        }
        .developer-credit img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid #ddd;
        }
        .developer-credit p {
            font-size: 0.9em;
            color: #555;
        }
        .developer-credit a {
            color: #007bff;
            text-decoration: none;
        }
        .developer-credit a:hover {
            text-decoration: underline;
        }
        #license-input { /* ID diubah ke license untuk script baru */
            margin-top: 10px;
        }
        #license-msg {
            margin-top: 10px;
            font-weight: bold;
        }
        /* Awalnya, main-app disembunyikan */
        #main-app-content {
            display: none;
        }

        /* Styling untuk foto pengguna di sidebar */
        #user-biodata {
            display: flex;
            flex-direction: column; /* Stack items vertically */
            align-items: center;   /* Center items horizontally */
            text-align: center;    /* Center text for children like user-name-display */
            margin-bottom: 20px; /* Increased margin for more space */
        }

        #user-photo-icon {
            /* margin-right: 10px; /* No longer needed */
            margin-bottom: 10px; /* Space between image and name */
        }

        #user-photo-icon img {
            width: 80px;  /* PERBESAR UKURAN GAMBAR */
            height: 80px; /* PERBESAR UKURAN GAMBAR */
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #007bff; /* Optional: thicker or different color border */
            display: block; /* Helps with centering if parent is not flex */
            margin-left: auto; /* Center image if parent is not flex & display: block */
            margin-right: auto;/* Center image if parent is not flex & display: block */
        }

        #user-name-display {
            font-weight: bold;
            font-size: 1.1em; /* Slightly larger font for the name */
        }

    </style>
</head>
<body>

    <!-- Container untuk Form Lisensi dan Login Awal -->
    <div id="license-form-container" class="container-view"> <!-- ID diubah menjadi license-form-container -->
        <h1><span class="app-title-highlight">Selamat Datang!</span></h1>
        <p class="app-description">
            Platform ini dirancang untuk membantu Anda, para calon perawat dalam mengasah pengetahuan dan mempersiapkan diri menghadapi berbagai ujian kompetensi keperawatan.
        </p>
        <p class="app-features-intro">Apa yang bisa Anda lakukan di sini?</p>
        <ul class="app-features">
            <li>Berlatih soal-soal sesuai kategori keperawatan.</li>
            <li>Menguji kemampuan secara menyeluruh dengan mode Try Out.</li>
            <li>Melihat pembahasan untuk memahami jawaban yang benar.</li>
        </ul>
        <p class="login-prompt">Siap untuk memulai? Silakan masukkan nama dan kode lisensi Anda:</p>
        <input type="text" id="name-input" placeholder="Nama Lengkap Anda">
        <input type="text" id="license" placeholder="Masukkan Kode Lisensi"> <!-- ID diubah ke 'license' -->
        <button id="submit-license-button">Masuk & Mulai Belajar</button> <!-- ID diubah ke 'submit-license-button' -->
        <div id="license-msg"></div> <!-- Elemen untuk pesan status lisensi -->
        <div class="developer-credit">
            <img src="https://masandigital.com/assets/images/author-photo.jpeg" alt="Developer Photo">
            <p>Dikembangkan oleh: Mas Andy -- Kunjungi: <a href="https://masandigital.com" target="_blank">masandigital.com </a>
            </p>
        </div>
    </div>
    <!-- Skrip Lisensi Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

      // !!! GANTI DENGAN KREDENSIAL FIREBASE ANDA SENDIRI !!!
      const firebaseConfig = {
        apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX", // GANTI INI
        authDomain: "nama-proyek-anda.firebaseapp.com", // GANTI INI
        databaseURL: "https://nama-proyek-anda.firebaseio.com", // GANTI INI (jika pakai Realtime DB, tapi kita Firestore)
        projectId: "nama-proyek-anda", // GANTI INI
        storageBucket: "nama-proyek-anda.appspot.com", // GANTI INI
        messagingSenderId: "000000000000", // GANTI INI
        appId: "1:000000000000:web:xxxxxxxxxxxxxxxxxxxxxx" // GANTI INI
      };
      // !!! BATAS KREDENSIAL FIREBASE !!!


      let db;

      // DOM Elements
      const licenseFormContainer = document.getElementById("license-form-container");
      const mainAppContent = document.getElementById("main-app-content");
      const submitButton = document.getElementById("submit-license-button");
      const licenseInput = document.getElementById("license");
      const nameInputElement = document.getElementById("name-input");
      const msgElement = document.getElementById("license-msg");
      const welcomeUserMessageEl = document.getElementById("welcome-user-message");
      const menuContainerEl = document.getElementById("menu-container");
      const userNameDisplayQuizEl = document.getElementById("user-name-display");
      const logoutButton = document.getElementById("logout-button");


      // Session Management Constants & Variables
      const STALE_SESSION_THRESHOLD = 5 * 60 * 1000; // 5 menit - Lisensi dianggap basi setelah waktu ini tanpa heartbeat
      const HEARTBEAT_INTERVAL = 2 * 60 * 1000; // 2 menit - Interval client mengirim "ping" masih aktif
      let heartbeatIntervalId = null;

      function generateClientSessionId() {
          return Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
      }

      function clearLocalSessionData() {
          if (sessionStorage) {
              sessionStorage.removeItem('licenseValidated');
              sessionStorage.removeItem('userName');
              sessionStorage.removeItem('licenseKey');
              sessionStorage.removeItem('clientSessionId');
          }
      }
      
      function showLoginForm(message = "") {
          if (heartbeatIntervalId) {
              clearInterval(heartbeatIntervalId);
              heartbeatIntervalId = null;
          }
          clearLocalSessionData();
          if (licenseFormContainer) licenseFormContainer.style.display = "block";
          if (mainAppContent) mainAppContent.style.display = "none";
          if (msgElement) {
              msgElement.textContent = message;
              const isErrorMessage = message.toLowerCase().includes("error") || 
                                   message.toLowerCase().includes("gagal") || 
                                   message.toLowerCase().includes("tidak") || 
                                   message.toLowerCase().includes("kesalahan");
              msgElement.style.color = isErrorMessage ? "red" : "blue";
          }
          if (submitButton) submitButton.disabled = false;
          if (licenseInput) licenseInput.value = "";
          // nameInputElement.value = ""; // Bisa dikomentari jika ingin nama tetap ada saat retry
      }

      function proceedToApp(userName, licenseKey, clientSessionId) {
          if (welcomeUserMessageEl) welcomeUserMessageEl.textContent = `Selamat datang, ${userName}!`;
          if (userNameDisplayQuizEl) userNameDisplayQuizEl.textContent = userName;
          
          if (sessionStorage) {
              sessionStorage.setItem('licenseValidated', 'true');
              sessionStorage.setItem('userName', userName);
              sessionStorage.setItem('licenseKey', licenseKey);
              sessionStorage.setItem('clientSessionId', clientSessionId);
          }

          if (licenseFormContainer) licenseFormContainer.style.display = "none";
          if (mainAppContent) mainAppContent.style.display = "block";
          if (menuContainerEl) menuContainerEl.classList.remove("hidden");
          if (msgElement) msgElement.textContent = ""; // Clear any previous messages

          startHeartbeat(licenseKey, clientSessionId);

          // Jika Anda memiliki fungsi untuk memuat artikel/data lain setelah login
          // if (typeof loadGeneratedArticles === 'function') {
          //    loadGeneratedArticles();
          // }
      }

      async function heartbeat(licenseKey, clientSessionId) {
          if (!db || !licenseKey || !clientSessionId) return;
          try {
              const docRef = doc(db, "licenses", licenseKey);
              const docSnap = await getDoc(docRef);

              if (docSnap.exists()) {
                  const data = docSnap.data();
                  if (data.active === true && data.activeSessionId === clientSessionId) {
                      await updateDoc(docRef, { lastSeenAt: serverTimestamp() });
                      // console.log("Heartbeat: Session renewed.", new Date().toLocaleTimeString());
                  } else {
                      console.warn("Heartbeat: Session conflict or license deactivated. Logging out.");
                      showLoginForm("Sesi Anda telah diakhiri karena lisensi digunakan di tempat lain atau tidak aktif lagi.");
                  }
              } else {
                  console.warn("Heartbeat: License document not found. Logging out.");
                  showLoginForm("Lisensi tidak ditemukan. Sesi diakhiri.");
              }
          } catch (error) {
              console.error("Heartbeat error:", error);
              if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                  showLoginForm(`Kesalahan izin pada heartbeat (${error.code}). Sesi diakhiri.`);
              }
              // Untuk error lain (misal jaringan sementara), jangan langsung logout, 
              // biarkan percobaan berikutnya atau login ulang yang menanganinya.
          }
      }

      function startHeartbeat(licenseKey, clientSessionId) {
          if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
          heartbeat(licenseKey, clientSessionId); // Initial heartbeat
          heartbeatIntervalId = setInterval(() => {
              heartbeat(licenseKey, clientSessionId);
          }, HEARTBEAT_INTERVAL);
      }

      try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);

          if (submitButton && licenseInput && msgElement && licenseFormContainer && mainAppContent && nameInputElement) {
              submitButton.addEventListener("click", async (e) => {
                  e.preventDefault();
                  const licenseKey = licenseInput.value.trim();
                  const inputUserName = nameInputElement.value.trim();

                  if (!inputUserName) {
                      msgElement.textContent = "Silakan masukkan nama Anda.";
                      msgElement.style.color = "red";
                      return;
                  }
                  if (!licenseKey) {
                      msgElement.textContent = "Silakan masukkan kode lisensi.";
                      msgElement.style.color = "red";
                      return;
                  }
                  if (licenseKey.includes('/')) {
                      msgElement.textContent = "Kode lisensi mengandung karakter tidak valid ('/').";
                      msgElement.style.color = "red";
                      return;
                  }

                  msgElement.textContent = "Memeriksa lisensi...";
                  msgElement.style.color = "orange";
                  submitButton.disabled = true;

                  try {
                      const docRef = doc(db, "licenses", licenseKey);
                      const docSnap = await getDoc(docRef);

                      if (docSnap.exists() && docSnap.data().active === true) {
                          const licenseData = docSnap.data();
                          const storedSessionId = licenseData.activeSessionId;
                          const lastSeenTimestamp = licenseData.lastSeenAt; 
                          const lastSeenDate = lastSeenTimestamp ? lastSeenTimestamp.toDate() : null;
                          
                          let canTakeLicense = false;

                          if (!storedSessionId) { // Lisensi belum pernah dipakai / sudah di-release
                              canTakeLicense = true;
                          } else { // Ada session ID, cek apakah basi atau orphaned
                              if (!lastSeenDate) { // Ada session ID tapi tidak ada lastSeenAt (orphaned)
                                  console.warn(`License ${licenseKey} has activeSessionId (${storedSessionId}) but no valid lastSeenAt timestamp. Considering it available.`);
                                  canTakeLicense = true;
                              } else { // Ada session ID dan lastSeenAt, cek apakah basi
                                  if ((new Date().getTime() - lastSeenDate.getTime()) > STALE_SESSION_THRESHOLD) {
                                      console.log(`License ${licenseKey} session ${storedSessionId} is stale. Last seen: ${lastSeenDate}. Current time: ${new Date()}`);
                                      canTakeLicense = true; 
                                  } else { // Sesi masih aktif dan belum basi
                                      console.log(`License ${licenseKey} session ${storedSessionId} is active and not stale. Last seen: ${lastSeenDate}`);
                                      canTakeLicense = false; 
                                  }
                              }
                          }

                          if (canTakeLicense) {
                              const newClientSessionId = generateClientSessionId();
                              await updateDoc(docRef, {
                                  activeSessionId: newClientSessionId,
                                  lastSeenAt: serverTimestamp(),
                              });
                              msgElement.style.color = "green";
                              msgElement.textContent = "Lisensi valid. Akses diberikan!";
                              proceedToApp(inputUserName, licenseKey, newClientSessionId);
                          } else {
                              msgElement.style.color = "red";
                              msgElement.textContent = "Lisensi ini sedang aktif digunakan di browser/perangkat lain.";
                              clearLocalSessionData();
                          }
                      } else {
                          msgElement.style.color = "red";
                          if (!docSnap.exists()) {
                             msgElement.textContent = "Mohon maaf, Lisensi tidak ditemukan.";
                          } else if (docSnap.data().active === false) { // Periksa jika ada field active dan false
                             msgElement.textContent = "Mohon maaf, Lisensi ini tidak aktif.";
                          } else { // Fallback jika field active tidak ada atau kondisi lain
                             msgElement.textContent = "Mohon maaf, Lisensi tidak ditemukan atau tidak aktif.";
                          }
                          clearLocalSessionData();
                      }
                  } catch (error) {
                      console.error("Firestore GAGAL saat memeriksa lisensi:", error);
                      if (error.code) {
                          console.error("Kode Error Firebase:", error.code); 
                      }
                      msgElement.style.color = "red";
                      msgElement.textContent = `Terjadi kesalahan (${error.code || 'Tidak Diketahui'}). Cek koneksi & lihat konsol browser (F12) untuk detail.`;
                      clearLocalSessionData();
                  } finally {
                      submitButton.disabled = false;
                  }
              });

              // Check session storage on page load for session resume
              if (sessionStorage && sessionStorage.getItem('licenseValidated') === 'true') {
                  const savedUserName = sessionStorage.getItem('userName');
                  const savedLicenseKey = sessionStorage.getItem('licenseKey');
                  const savedClientSessionId = sessionStorage.getItem('clientSessionId');

                  if (savedUserName && savedLicenseKey && savedClientSessionId) {
                      msgElement.textContent = "Memvalidasi sesi sebelumnya...";
                      msgElement.style.color = "orange";
                      (async () => {
                          try {
                              const docRef = doc(db, "licenses", savedLicenseKey);
                              const docSnap = await getDoc(docRef);
                              if (docSnap.exists() && 
                                  docSnap.data().active === true && 
                                  docSnap.data().activeSessionId === savedClientSessionId) {
                                  
                                  await updateDoc(docRef, { lastSeenAt: serverTimestamp() }); // Perbarui lastSeenAt saat resume
                                  proceedToApp(savedUserName, savedLicenseKey, savedClientSessionId);
                              } else {
                                  showLoginForm("Sesi sebelumnya tidak valid atau telah diambil alih. Silakan masuk kembali.");
                              }
                          } catch (err) {
                              console.error("Error re-validating session:", err);
                              showLoginForm(`Gagal memvalidasi sesi (${err.code || 'Tidak Diketahui'}). Silakan masuk kembali.`);
                          }
                      })();
                  } else { // Data session storage tidak lengkap
                      clearLocalSessionData();
                  }
              }

          } else {
              console.error("Elemen form lisensi atau aplikasi utama tidak ditemukan! Periksa ID elemen.");
              if(msgElement) {
                msgElement.textContent = "Kesalahan konfigurasi halaman.";
                msgElement.style.color = "red";
              }
          }
      } catch (error) { 
          console.error("Inisialisasi Firebase gagal:", error);
          if(msgElement) {
             msgElement.textContent = `Gagal menginisialisasi koneksi ke server (${error.code || 'Tidak Diketahui'}). Silakan coba lagi nanti.`;
             msgElement.style.color = "red";
          }
      }

      // Logout Handler
      if (logoutButton) {
          logoutButton.addEventListener('click', async () => {
              const licenseKey = sessionStorage.getItem('licenseKey');
              const clientSessionId = sessionStorage.getItem('clientSessionId'); // Ambil clientSessionId saat ini

              if (db && licenseKey && clientSessionId) { // Pastikan clientSessionId juga ada
                  try {
                      const docRef = doc(db, "licenses", licenseKey);
                      const docSnap = await getDoc(docRef); 
                      // Hanya bebaskan lisensi jika session ID di server sama dengan session ID browser ini
                      if (docSnap.exists() && docSnap.data().activeSessionId === clientSessionId) {
                          await updateDoc(docRef, {
                              activeSessionId: null, // Kosongkan session ID
                              lastSeenAt: serverTimestamp() // Catat waktu logout
                          });
                          console.log("License released on logout.");
                      } else if (docSnap.exists()) {
                          console.log("Session already released or taken by another client. Local logout only.");
                      } else {
                          console.log("License document not found during logout. Local logout only.");
                      }
                  } catch (error) {
                      console.error("Error releasing license on logout:", error);
                      // Tetap lanjutkan logout lokal meskipun gagal update server
                  }
              }
              showLoginForm("Anda telah berhasil logout.");
          });
      }

      // beforeunload handler: Best effort untuk update lastSeenAt
      // Ini membantu agar sesi lebih cepat dianggap basi jika browser ditutup mendadak
      window.addEventListener('beforeunload', (event) => {
          if (sessionStorage && sessionStorage.getItem('licenseValidated') === 'true') {
              const licenseKey = sessionStorage.getItem('licenseKey');
              const clientSessionId = sessionStorage.getItem('clientSessionId'); // Ambil session ID kita

              // Hanya update jika licenseKey dan clientSessionId ada, dan db terinisialisasi
              if (db && licenseKey && clientSessionId) { 
                  const docRef = doc(db, "licenses", licenseKey);
                  
                  // Ini adalah "fire-and-forget". Browser tidak akan menunggu ini selesai.
                  // Kita tidak bisa menggunakan 'await' di sini.
                  // Tujuannya hanya untuk memberi tahu server "saya terakhir terlihat sekarang".
                  // Jangan set activeSessionId ke null, karena refresh halaman biasa juga memicu beforeunload.
                  // Staleness check saat login adalah mekanisme utama yang lebih andal.

                  // Untuk meningkatkan keandalan, kita bisa coba periksa dulu apakah session masih milik kita,
                  // tapi ini akan membutuhkan getDoc() yang asinkron, yang sulit di beforeunload.
                  // Jadi, kita langsung coba update lastSeenAt. Heartbeat akan mengoreksi jika sesi sudah diambil alih.
                  
                  // Solusi yang lebih andal untuk 'beforeunload' adalah menggunakan navigator.sendBeacon()
                  // ke sebuah Cloud Function yang kemudian mengupdate Firestore.
                  // Namun, untuk solusi client-side murni, ini adalah pendekatan yang wajar.
                  
                  updateDoc(docRef, {
                      lastSeenAt: serverTimestamp() 
                  }).then(() => {
                      // console.log("beforeunload: Attempted to update lastSeenAt for our session.");
                  }).catch(err => {
                      // console.warn("beforeunload: Error updating lastSeenAt (non-critical):", err);
                  });
              }
          }
      });

    </script>
    <!-- Kontainer untuk Aplikasi Utama (setelah lisensi valid) -->
    <div id="main-app-content"> <!-- ID diubah menjadi main-app-content -->
        <div id="menu-container" class="container-view hidden">
            <h2 id="welcome-user-message"></h2>
            <h3>Silakan pilih mode:</h3>
            <button id="latihan-soal-menu-button">Latihan Soal</button>
            <button id="tryout-button">Try Out</button>
            <button id="logout-button" class="btn-home">Logout</button>
        </div>

        <div id="kategori-latihan-container" class="container-view hidden">
            <h3>Pilih Kategori Latihan Soal</h3>
            <button class="kategori-button" data-script="jiwa.js">Keperawatan Jiwa</button>
            <button class="kategori-button" data-script="anak.js">Keperawatan Anak</button>
            <button class="kategori-button" data-script="keluarga.js">Keperawatan Keluarga</button>
            <button class="kategori-button" data-script="komunitas.js">Keperawatan Komunitas</button>
            <button class="kategori-button" data-script="bedah.js">Keperawatan Medikal Bedah</button>
            <button class="kategori-button" data-script="gadar.js">Keperawatan Gawat Darurat</button>
            <button class="kategori-button" data-script="manajemen.js">Manajemen Keperawatan</button>
            <button id="kembali-ke-menu-utama-button" class="btn-home">Kembali ke Menu Utama</button>
        </div>

        <div id="quiz-layout-container" class="container-view hidden">
            <div id="quiz-main-content">
                <div id="question-counter" class="hidden">Soal 1 dari X</div>
                <div id="question"></div>
                <div id="options-container"></div>
                <div id="explanation" class="hidden"></div>
                <div id="navigation-buttons">
                    <button id="doubtful-button" class="btn-doubtful hidden">Tandai Ragu-ragu</button>
                    <button class="btn-next" id="next-question-button" class="hidden">Soal Berikutnya</button>
                    <button class="btn-home" id="quiz-back-button">Kembali</button>
                </div>
            </div>

            <div id="quiz-sidebar">
                <div id="user-biodata"> <!-- Container untuk foto dan nama -->
                    <div id="user-photo-icon">
                        <img src="user.png" alt="Foto Pengguna"> <!-- Pastikan user.png ada -->
                    </div>
                    <div id="user-name-display">Nama Pengguna</div>
                </div>
                <div id="timer-display-sidebar" class="hidden">
                    Sisa Waktu: <span id="time-left-sidebar">180:00</span>
                </div>
                <div id="question-navigation-panel">
                    <h4>Navigasi Soal</h4>
                    <div id="question-navigation-grid">
                    </div>
                </div>
            </div>
        </div>

        <div id="result-container" class="container-view hidden">
            <p id="score"></p>
            <button id="restart-button">Mulai Lagi</button>
        </div>

        <footer id="footer">
            <center><p>With Love © Copyright by Mas Andy</p></center>
        </footer>
    </div>


    <!-- Skrip Aplikasi Utama Anda (logika kuis, dll.) -->
    <script src="script.js"></script>
       <!-- Histats.com  (div with counter) --><div id="histats_counter"></div>
<script type="text/javascript">var _Hasync= _Hasync|| [];
_Hasync.push(['Histats.start', '1,4842415,4,1,120,40,00011111']);
_Hasync.push(['Histats.fasi', '1']);
_Hasync.push(['Histats.track_hits', '']);
(function() {
var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
hs.src = ('//s10.histats.com/js15_as.js');
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
})();</script>
<noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?4842415&101" alt="" border="0"></a></noscript>

</body>
</html>
