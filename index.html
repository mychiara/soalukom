<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Soal Keperawatan</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .developer-credit {
            margin-top: 20px;
            text-align: center;
        }
        .developer-credit img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid #ddd;
        }
        .developer-credit p {
            font-size: 0.9em;
            color: #555;
        }
        .developer-credit a {
            color: #007bff;
            text-decoration: none;
        }
        .developer-credit a:hover {
            text-decoration: underline;
        }
        #license-input {
            margin-top: 10px;
        }
        #license-msg {
            margin-top: 10px;
            font-weight: bold;
        }
        #main-app-content {
            display: none;
        }
        #user-biodata {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
        }
        #user-photo-icon {
            margin-bottom: 10px;
        }
        #user-photo-icon img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #007bff;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #user-name-display {
            font-weight: bold;
            font-size: 1.1em;
        }
    </style>
</head>
<body>

    <div id="license-form-container" class="container-view">
        <h1><span class="app-title-highlight">Selamat Datang!</span></h1>
        <p class="app-description">
            Platform ini dirancang untuk membantu Anda, para calon perawat dalam mengasah pengetahuan dan mempersiapkan diri menghadapi berbagai ujian kompetensi keperawatan.
        </p>
        <p class="app-features-intro">Apa yang bisa Anda lakukan di sini?</p>
        <ul class="app-features">
            <li>Berlatih soal-soal sesuai kategori keperawatan.</li>
            <li>Menguji kemampuan secara menyeluruh dengan mode Try Out.</li>
            <li>Melihat pembahasan untuk memahami jawaban yang benar.</li>
        </ul>
        <p class="login-prompt">Siap untuk memulai? Silakan masukkan nama dan kode lisensi Anda:</p>
        <input type="text" id="name-input" placeholder="Nama Lengkap Anda">
        <input type="text" id="license" placeholder="Masukkan Kode Lisensi">
        <button id="submit-license-button">Masuk & Mulai Belajar</button>
        <div id="license-msg"></div>
        <div class="developer-credit">
            <img src="https://masandigital.com/assets/images/author-photo.jpeg" alt="Developer Photo">
            <p>Dikembangkan oleh: Mas Andy -- Kunjungi: <a href="https://masandigital.com" target="_blank">masandigital.com </a>
            </p>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

      const firebaseConfig = {
          apiKey: "AIzaSyDnJvECVfNJIXPh9rZTsA3QcHQaTiE4Awc", // GANTI DENGAN API KEY ANDA
          authDomain: "apodaca-bessie4762.firebaseapp.com",
          databaseURL: "https://apodaca-bessie4762.firebaseio.com",
          projectId: "apodaca-bessie4762",
          storageBucket: "apodaca-bessie4762.firebasestorage.app",
          messagingSenderId: "809433417541",
          appId: "1:809433417541:web:48632b970a90840ab1602c"
      };

      let db;

      const licenseFormContainer = document.getElementById("license-form-container");
      const mainAppContent = document.getElementById("main-app-content");
      const submitButton = document.getElementById("submit-license-button");
      const licenseInput = document.getElementById("license");
      const nameInputElement = document.getElementById("name-input");
      const msgElement = document.getElementById("license-msg");
      const welcomeUserMessageEl = document.getElementById("welcome-user-message");
      const menuContainerEl = document.getElementById("menu-container");
      const userNameDisplayQuizEl = document.getElementById("user-name-display");
      const logoutButton = document.getElementById("logout-button");

      function getOrCreateDeviceId() {
          let deviceId = localStorage.getItem('appDeviceId');
          if (!deviceId) {
              deviceId = 'device_' + Math.random().toString(36).substring(2, 15) + Date.now();
              localStorage.setItem('appDeviceId', deviceId);
          }
          return deviceId;
      }
      const currentDeviceId = getOrCreateDeviceId(); // Dapatkan deviceId saat skrip dimuat

      function proceedToApp(userName, licenseKey) {
          if (welcomeUserMessageEl) welcomeUserMessageEl.textContent = `Selamat datang, ${userName}!`;
          if (userNameDisplayQuizEl) userNameDisplayQuizEl.textContent = userName;

          sessionStorage.setItem('licenseValidated', 'true');
          sessionStorage.setItem('userName', userName);
          sessionStorage.setItem('licenseKey', licenseKey);
          // Tidak perlu simpan deviceId di session, karena kita selalu dapatkan dari localStorage via getOrCreateDeviceId()
          // dan kita bandingkan langsung dengan yang ada di Firestore.

          if (licenseFormContainer) licenseFormContainer.style.display = "none";
          if (mainAppContent) mainAppContent.style.display = "block";
          if (menuContainerEl) menuContainerEl.classList.remove("hidden");

          if (typeof loadGeneratedArticles === 'function') {
             loadGeneratedArticles();
          }
      }

      async function handleLogout() {
          const validatedLicenseKey = sessionStorage.getItem('licenseKey');
          // Dapatkan deviceId dari localStorage, karena ini yang akan dibandingkan
          const deviceIdForLogout = localStorage.getItem('appDeviceId');

          if (validatedLicenseKey && deviceIdForLogout && db) {
              msgElement.textContent = "Memproses logout...";
              msgElement.style.color = "orange";
              try {
                  const docRef = doc(db, "licenses", validatedLicenseKey);
                  const docSnap = await getDoc(docRef);

                  // Hanya hapus activeDeviceId jika device yang logout adalah device yang tercatat
                  if (docSnap.exists() && docSnap.data().activeDeviceId === deviceIdForLogout) {
                      await updateDoc(docRef, {
                          activeDeviceId: deleteField(),
                          lastSeen: deleteField(),
                          // userName: deleteField() // Hapus juga userName jika Anda menyimpannya di Firestore
                      });
                      console.log("Device ID and related info cleared from license on logout.");
                      msgElement.textContent = "Anda telah logout. Lisensi telah dibebaskan.";
                      msgElement.style.color = "green";
                  } else if (docSnap.exists() && docSnap.data().activeDeviceId && docSnap.data().activeDeviceId !== deviceIdForLogout) {
                      // Ini skenario aneh, device lain yang tercatat, bukan device ini.
                      // Tetap logout sisi klien, tapi beri tahu user.
                      console.warn("Logout initiated, but a different device ID was active on the license.");
                      msgElement.textContent = "Anda telah logout. Lisensi ini masih terdaftar aktif oleh perangkat lain.";
                      msgElement.style.color = "orange";
                  } else {
                      // Lisensi tidak ada atau activeDeviceId sudah kosong.
                      console.log("Logout processed, license was already free or not found.");
                      msgElement.textContent = "Anda telah logout.";
                      msgElement.style.color = "blue";
                  }
              } catch (error) {
                  console.error("Error clearing device ID on logout:", error);
                  msgElement.textContent = "Terjadi kesalahan saat logout. Coba lagi.";
                  msgElement.style.color = "red";
                  // Jangan langsung lanjutkan ke pembersihan session jika gagal update DB
                  return;
              }
          } else {
              msgElement.textContent = "Informasi sesi tidak lengkap untuk logout.";
              msgElement.style.color = "red";
          }

          // Selalu lakukan pembersihan sisi klien setelah upaya logout (berhasil atau tidak interaksi DB-nya)
          sessionStorage.removeItem('licenseValidated');
          sessionStorage.removeItem('userName');
          sessionStorage.removeItem('licenseKey');
          // localStorage.removeItem('appDeviceId'); // JANGAN HAPUS appDeviceId dari localStorage,
                                                  // karena ini identitas browser/perangkat.

          if (mainAppContent) mainAppContent.style.display = "none";
          if (licenseFormContainer) licenseFormContainer.style.display = "block";
          if (menuContainerEl) menuContainerEl.classList.add("hidden");
          if (licenseInput) licenseInput.value = "";
          if (nameInputElement) nameInputElement.value = "";
          // Pesan sudah diatur di atas
      }

      if (logoutButton) {
          logoutButton.addEventListener('click', handleLogout);
      }

      try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);

          if (submitButton && licenseInput && msgElement && licenseFormContainer && mainAppContent && nameInputElement) {
              submitButton.addEventListener("click", async (e) => {
                  e.preventDefault();
                  const licenseKey = licenseInput.value.trim();
                  const inputUserName = nameInputElement.value.trim() || "Pengguna";
                  const deviceIdForLogin = getOrCreateDeviceId(); // Gunakan deviceId saat ini untuk login

                  if (!licenseKey) {
                      msgElement.textContent = "Silakan masukkan kode lisensi.";
                      msgElement.style.color = "red";
                      return;
                  }
                  if (!inputUserName || (inputUserName === "Pengguna" && nameInputElement.value.trim() === "")) {
                      msgElement.textContent = "Silakan masukkan nama Anda.";
                      msgElement.style.color = "red";
                      return;
                  }

                  msgElement.textContent = "Memeriksa lisensi...";
                  msgElement.style.color = "orange";
                  submitButton.disabled = true;

                  try {
                      const docRef = doc(db, "licenses", licenseKey);
                      const docSnap = await getDoc(docRef);

                      if (docSnap.exists() && docSnap.data().active === true) {
                          const licenseData = docSnap.data();

                          // Cek apakah lisensi sedang digunakan oleh device lain
                          if (licenseData.activeDeviceId && licenseData.activeDeviceId !== deviceIdForLogin) {
                              // Tambahan: Cek lastSeen untuk potensi sesi "stale"
                              const lastSeenTimestamp = licenseData.lastSeen ? licenseData.lastSeen.toDate() : null;
                              const STALE_SESSION_TIMEOUT_MS = 30 * 60 * 1000; // Contoh: 30 menit

                              if (lastSeenTimestamp && (Date.now() - lastSeenTimestamp.getTime()) > STALE_SESSION_TIMEOUT_MS) {
                                  console.warn(`License ${licenseKey} was active on ${licenseData.activeDeviceId}, but lastSeen is stale. Overwriting.`);
                                  // Anggap sesi sebelumnya stale, izinkan login
                                  await updateDoc(docRef, {
                                      activeDeviceId: deviceIdForLogin,
                                      lastSeen: serverTimestamp(),
                                      // userName: inputUserName // Simpan nama jika diinginkan
                                  });
                                  msgElement.style.color = "green";
                                  msgElement.textContent = "Lisensi valid (sesi sebelumnya kedaluwarsa). Akses diberikan!";
                                  proceedToApp(inputUserName, licenseKey);
                              } else {
                                  msgElement.style.color = "red";
                                  msgElement.textContent = `Lisensi ini sedang digunakan di perangkat lain (${licenseData.activeDeviceId ? '...' + licenseData.activeDeviceId.slice(-6) : 'ID tidak diketahui'}). Silakan logout dari perangkat tersebut atau tunggu.`;
                                  sessionStorage.removeItem('licenseValidated');
                              }
                          } else {
                              // Lisensi valid dan (tidak sedang digunakan ATAU digunakan oleh device ini sebelumnya)
                              await updateDoc(docRef, {
                                  activeDeviceId: deviceIdForLogin,
                                  lastSeen: serverTimestamp(),
                                  // userName: inputUserName // Simpan nama jika diinginkan
                              });
                              msgElement.style.color = "green";
                              msgElement.textContent = "Lisensi valid. Akses diberikan!";
                              proceedToApp(inputUserName, licenseKey);
                          }
                      } else {
                          msgElement.style.color = "red";
                          msgElement.textContent = docSnap.exists() && !docSnap.data().active ? "Lisensi tidak aktif." : "Lisensi tidak ditemukan.";
                          sessionStorage.removeItem('licenseValidated');
                      }
                  } catch (error) {
                      console.error("Terjadi kesalahan saat memeriksa lisensi:", error);
                      msgElement.style.color = "red";
                      msgElement.textContent = "Terjadi kesalahan saat memeriksa lisensi. Cek koneksi internet Anda.";
                      sessionStorage.removeItem('licenseValidated');
                  } finally {
                      submitButton.disabled = false;
                  }
              });

              // Check session storage on page load
              if (sessionStorage.getItem('licenseValidated') === 'true') {
                   const savedUserName = sessionStorage.getItem('userName') || "Pengguna";
                   const savedLicenseKey = sessionStorage.getItem('licenseKey');
                   const deviceIdFromStorage = localStorage.getItem('appDeviceId'); // Ini ID perangkat saat ini

                   if (savedLicenseKey && deviceIdFromStorage && db) { // Pastikan db juga sudah siap
                        // Verifikasi ulang ke Firebase apakah device ini masih yang berhak
                        (async () => {
                            try {
                                const docRef = doc(db, "licenses", savedLicenseKey);
                                const docSnap = await getDoc(docRef);
                                if (docSnap.exists() && docSnap.data().active === true && docSnap.data().activeDeviceId === deviceIdFromStorage) {
                                    // Update lastSeen saat memuat ulang sesi yang valid
                                    await updateDoc(docRef, { lastSeen: serverTimestamp() });
                                    proceedToApp(savedUserName, savedLicenseKey);
                                } else {
                                    // Sesi tidak valid lagi (mungkin diambil alih atau lisensi nonaktif)
                                    msgElement.textContent = "Sesi Anda tidak valid lagi. Silakan login kembali.";
                                    msgElement.style.color = "red";
                                    handleLogout(); // Lakukan proses logout bersih
                                }
                            } catch (error) {
                                console.error("Error re-validating session:", error);
                                msgElement.textContent = "Gagal memvalidasi ulang sesi. Silakan login kembali.";
                                msgElement.style.color = "red";
                                handleLogout(); // Lakukan proses logout bersih
                            }
                        })();
                   } else {
                       // Jika ada yang kurang, paksa login ulang
                       sessionStorage.removeItem('licenseValidated');
                       sessionStorage.removeItem('userName');
                       sessionStorage.removeItem('licenseKey');
                   }
              }
          } else {
              console.error("Elemen form lisensi atau aplikasi utama tidak ditemukan! Periksa ID elemen.");
              if(msgElement) {
                msgElement.textContent = "Kesalahan konfigurasi halaman.";
                msgElement.style.color = "red";
              }
          }
      } catch (error) {
          console.error("Inisialisasi Firebase gagal:", error);
          if(msgElement) {
             msgElement.textContent = "Gagal menginisialisasi koneksi. Silakan coba lagi nanti.";
             msgElement.style.color = "red";
          }
      }
    </script>

    <div id="main-app-content">
        <div id="menu-container" class="container-view hidden">
            <h2 id="welcome-user-message"></h2>
            <h3>Silakan pilih mode:</h3>
            <button id="latihan-soal-menu-button">Latihan Soal</button>
            <button id="tryout-button">Try Out</button>
            <button id="logout-button" class="btn-home">Logout</button>
        </div>

        <div id="kategori-latihan-container" class="container-view hidden">
            <h3>Pilih Kategori Latihan Soal</h3>
            <button class="kategori-button" data-script="jiwa.js">Keperawatan Jiwa</button>
            <button class="kategori-button" data-script="anak.js">Keperawatan Anak</button>
            <button class="kategori-button" data-script="keluarga.js">Keperawatan Keluarga</button>
            <button class="kategori-button" data-script="komunitas.js">Keperawatan Komunitas</button>
            <button class="kategori-button" data-script="bedah.js">Keperawatan Medikal Bedah</button>
            <button class="kategori-button" data-script="gadar.js">Keperawatan Gawat Darurat</button>
            <button class="kategori-button" data-script="manajemen.js">Manajemen Keperawatan</button>
            <button id="kembali-ke-menu-utama-button" class="btn-home">Kembali ke Menu Utama</button>
        </div>

        <div id="quiz-layout-container" class="container-view hidden">
            <div id="quiz-main-content">
                <div id="question-counter" class="hidden">Soal 1 dari X</div>
                <div id="question"></div>
                <div id="options-container"></div>
                <div id="explanation" class="hidden"></div>
                <div id="navigation-buttons">
                    <button id="doubtful-button" class="btn-doubtful hidden">Tandai Ragu-ragu</button>
                    <button class="btn-next" id="next-question-button" class="hidden">Soal Berikutnya</button>
                    <button class="btn-home" id="quiz-back-button">Kembali</button>
                </div>
            </div>

            <div id="quiz-sidebar">
                <div id="user-biodata">
                    <div id="user-photo-icon">
                        <img src="user.png" alt="Foto Pengguna">
                    </div>
                    <div id="user-name-display">Nama Pengguna</div>
                </div>
                <div id="timer-display-sidebar" class="hidden">
                    Sisa Waktu: <span id="time-left-sidebar">180:00</span>
                </div>
                <div id="question-navigation-panel">
                    <h4>Navigasi Soal</h4>
                    <div id="question-navigation-grid">
                    </div>
                </div>
            </div>
        </div>

        <div id="result-container" class="container-view hidden">
            <p id="score"></p>
            <button id="restart-button">Mulai Lagi</button>
        </div>

        <footer id="footer">
            <center><p>With Love © Copyright by Mas Andy</p></center>
        </footer>
    </div>

    <script src="script.js"></script>
    <!-- Histats -->
</body>
</html>
